[[extend 'layout.html']]

<div class="container mt-4">
    <!-- User Info Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            [[if oauth_data and oauth_data.get(user.primary_platform, {}).get('avatar_url'):]]
                            <img src="[[=oauth_data[user.primary_platform]['avatar_url']]]" 
                                 alt="Avatar" class="rounded-circle" width="64" height="64">
                            [[else:]]
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 64px; height: 64px;">
                                <i class="fas fa-user text-white fa-2x"></i>
                            </div>
                            [[pass]]
                        </div>
                        <div class="col">
                            <h4 class="mb-1">[[=user.waddlebot_display_name or user.username]]</h4>
                            <p class="text-muted mb-1">WaddleBot User #[[=user.id]]</p>
                            [[if user.primary_platform:]]
                            <p class="mb-0">
                                <span class="badge bg-[[=user.primary_platform]]">
                                    <i class="fab fa-[[=user.primary_platform]]"></i> 
                                    Primary: [[=user.primary_platform.title()]]
                                </span>
                            </p>
                            [[pass]]
                        </div>
                        <div class="col-auto">
                            <div class="text-center">
                                <h5 class="mb-0">[[=user.reputation_score or 0]]</h5>
                                <small class="text-muted">Reputation</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Linked Platforms -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-link"></i> Linked Platforms</h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#linkPlatformModal">
                        <i class="fas fa-plus"></i> Link Platform
                    </button>
                </div>
                <div class="card-body">
                    [[if platforms:]]
                    <div class="list-group list-group-flush">
                        [[for platform in platforms:]]
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div class="d-flex align-items-center">
                                [[if oauth_data.get(platform.platform, {}).get('avatar_url'):]]
                                <img src="[[=oauth_data[platform.platform]['avatar_url']]]" 
                                     alt="[[=platform.platform]] avatar" class="rounded me-3" width="40" height="40">
                                [[else:]]
                                <div class="bg-[[=platform.platform]] rounded d-flex align-items-center justify-content-center me-3" 
                                     style="width: 40px; height: 40px;">
                                    <i class="fab fa-[[=platform.platform]] text-white"></i>
                                </div>
                                [[pass]]
                                <div>
                                    <h6 class="mb-0">[[=platform.platform.title()]]</h6>
                                    <small class="text-muted">@[[=platform.platform_username]]</small>
                                    [[if platform.platform == user.primary_platform:]]
                                    <span class="badge bg-success ms-2">Primary</span>
                                    [[pass]]
                                </div>
                            </div>
                            <div>
                                <small class="text-muted">
                                    [[if platform.verification_method == 'oauth':]]
                                    <i class="fas fa-shield-alt text-success"></i> OAuth
                                    [[else:]]
                                    <i class="fas fa-check text-success"></i> Verified
                                    [[pass]]
                                </small>
                            </div>
                        </div>
                        [[pass]]
                    </div>
                    [[else:]]
                    <div class="text-center py-4">
                        <i class="fas fa-link fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No platforms linked yet</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#linkPlatformModal">
                            <i class="fas fa-plus"></i> Link Your First Platform
                        </button>
                    </div>
                    [[pass]]
                </div>
            </div>
        </div>
        
        <!-- API Keys -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-key"></i> API Keys</h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
                        <i class="fas fa-plus"></i> Create Key
                    </button>
                </div>
                <div class="card-body">
                    [[if api_keys:]]
                    <div class="list-group list-group-flush">
                        [[for key in api_keys:]]
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <h6 class="mb-1">[[=key.name]]</h6>
                                <small class="text-muted">
                                    Created [[=key.created_at.strftime('%Y-%m-%d')]]
                                    [[if key.last_used_at:]]
                                    â€¢ Last used [[=key.last_used_at.strftime('%Y-%m-%d')]]
                                    [[pass]]
                                </small>
                                [[if key.expires_at:]]
                                <br><small class="text-warning">Expires [[=key.expires_at.strftime('%Y-%m-%d')]]</small>
                                [[pass]]
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="regenerateKey([[=key.id]])">
                                    <i class="fas fa-sync"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="revokeKey([[=key.id]])">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        [[pass]]
                    </div>
                    [[else:]]
                    <div class="text-center py-4">
                        <i class="fas fa-key fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No API keys created yet</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
                            <i class="fas fa-plus"></i> Create Your First API Key
                        </button>
                    </div>
                    [[pass]]
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Link Platform Modal -->
<div class="modal fade" id="linkPlatformModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Link New Platform</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Choose a platform to link to your WaddleBot identity:</p>
                
                <div class="d-grid gap-2">
                    <a href="[[=URL('auth/oauth/discord')]]" class="btn btn-discord">
                        <i class="fab fa-discord"></i> Link Discord Account
                    </a>
                    <a href="[[=URL('auth/oauth/twitch')]]" class="btn btn-twitch">
                        <i class="fab fa-twitch"></i> Link Twitch Account
                    </a>
                    <a href="[[=URL('auth/oauth/slack')]]" class="btn btn-slack">
                        <i class="fab fa-slack"></i> Link Slack Account
                    </a>
                </div>
                
                <hr class="my-3">
                
                <p class="small text-muted">
                    <strong>Alternative:</strong> You can also link platforms by typing 
                    <code>!identity link &lt;platform&gt; &lt;username&gt;</code> in any linked platform's chat.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create API Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createKeyForm">
                    <div class="mb-3">
                        <label for="keyName" class="form-label">Key Name</label>
                        <input type="text" class="form-control" id="keyName" name="name" 
                               placeholder="e.g., My Bot Key" required>
                        <div class="form-text">Choose a descriptive name for this API key.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="keyExpiry" class="form-label">Expires In</label>
                        <select class="form-select" id="keyExpiry" name="expires_in_days">
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="365" selected>1 year</option>
                            <option value="0">Never expires</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createApiKey()">
                    <i class="fas fa-key"></i> Create Key
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function createApiKey() {
    const form = document.getElementById('createKeyForm');
    const formData = new FormData(form);
    
    fetch('[[=URL("identity/api-keys")]]', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: formData.get('name'),
            expires_in_days: parseInt(formData.get('expires_in_days')) || 365
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('API Key created successfully!\n\nKey: ' + data.api_key + '\n\nSave this key securely - it won\'t be shown again!');
            location.reload();
        } else {
            alert('Error creating API key: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error creating API key: ' + error.message);
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('createKeyModal'));
    modal.hide();
}

function regenerateKey(keyId) {
    if (!confirm('Are you sure you want to regenerate this API key? The old key will stop working immediately.')) {
        return;
    }
    
    fetch(`[[=URL("identity/api-keys")]]/${keyId}/regenerate`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('API Key regenerated successfully!\n\nNew Key: ' + data.api_key + '\n\nSave this key securely - it won\'t be shown again!');
            location.reload();
        } else {
            alert('Error regenerating API key: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error regenerating API key: ' + error.message);
    });
}

function revokeKey(keyId) {
    if (!confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) {
        return;
    }
    
    fetch(`[[=URL("identity/api-keys")]]/${keyId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('API key revoked successfully');
            location.reload();
        } else {
            alert('Error revoking API key: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error revoking API key: ' + error.message);
    });
}
</script>